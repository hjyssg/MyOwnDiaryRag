# 日记管理系统 - 任务规划

## 任务一：优化导入拆分算法

### 现存问题
1. **优先级逻辑不合理**：所有非index.md文件都先尝试多日拆分，导致单日小文件被误拆
2. **日期正则太激进**：两位数模式误伤严重，缺少月份范围校验（1-12月）
3. **同日重复条目被覆盖**：同一天写了两次的内容丢失，应合并并标记
4. **日期笔误无检测**：如 `1002` 实为 `0102` 的笔误，应输出警告
5. **股票日记等特殊文件未处理**：需新增 entry_type

### 优化方案
- **智能判断文件类型**：通过字数/文件大小预判。小文件（<2000字）且文件名可解析日期→单日；大文件→尝试多日拆分
- **日期正则加范围校验**：月份1-12，日期1-31
- **同日合并**：同一天多条内容用分隔符合并，标记 `[duplicate]`
- **笔误警告**：检测日期跳跃异常（如01月文件出现10月日期），输出WARNING
- **新增 entry_type**：
  - `stock_diary`：股票日记（文件名含"股票"）
  - `note`：其他笔记类文件（线下活动、游戏感想等）
- **标题行跳过**：识别并跳过 `20XX 生活日记` 等标题行

### 验证方法
- 运行导入后随机抽样10-20条检查
- 重点检查：2006年单日文件、2019-2026年多日文件、股票日记、同日重复

---

## 任务二：RAG 日记回忆工具

### 目标
支持自然语言查询个人记忆，例如：
- "我去过几次日本"
- "我去年去了几天厦门"
- "我初中的时候发生了什么"
- "我和猪头去过哪些餐厅"

### 架构设计

```
用户提问 → 查询理解(LLM) → 混合检索 → 上下文组装 → LLM回答
                                ↓
                    ┌──────────┴──────────┐
                    │                     │
              关键词检索(FTS5)      语义检索(Embedding)
                    │                     │
                    └──────────┬──────────┘
                               ↓
                         结果合并排序
```

### 核心模块

#### 1. 预处理层：事件/标签提取
- 用 LLM 对每条日记提取结构化标签：
  - **地点**：日本、厦门、上海、冲绳...
  - **人物**：猪头/唐欣、外婆、hyx、同事...
  - **事件类型**：旅行、漫展、吃饭、工作、健身、看病...
  - **情绪**：开心、生气、焦虑、感动...
- 存入新表 `diary_tags`

#### 2. 向量化层
- 对每条日记生成 embedding 向量
- 技术选型：
  - 本地模型：`sentence-transformers` (如 `paraphrase-multilingual-MiniLM-L12-v2`)
  - 或 API：OpenAI embedding / 其他
- 存储：`sqlite-vss` 或独立的 `chromadb`/`faiss`

#### 3. 检索层（混合检索）
- **关键词路径**：SQLite FTS5 全文搜索
- **语义路径**：embedding 相似度搜索
- **标签路径**：基于预提取的标签精确匹配
- **时间过滤**：解析查询中的时间范围（"去年"→2025年）
- 三路结果合并，去重排序

#### 4. LLM 回答层
- 将检索到的日记片段作为 context 发给 LLM
- LLM 负责：汇总、计数、时间线整理、情感分析
- 支持多轮对话（追问细节）

### 数据库扩展

```sql
-- 标签表
CREATE TABLE diary_tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entry_id INTEGER REFERENCES diary_entries(id),
    tag_type TEXT,  -- location/person/event/emotion
    tag_value TEXT,
    confidence REAL DEFAULT 1.0
);

-- 向量表（如用sqlite-vss）
CREATE VIRTUAL TABLE diary_vectors USING vss0(
    embedding(384)  -- 维度取决于模型
);
```

### 技术选型
| 组件 | 选项A（纯本地） | 选项B（API） |
|------|----------------|-------------|
| Embedding | sentence-transformers | OpenAI/Gemini |
| 向量存储 | chromadb/faiss | 同左 |
| LLM | ollama本地模型 | Claude/GPT API |
| 标签提取 | 本地LLM批处理 | API批处理 |

### 实现步骤
1. ✅ 先完成任务一（导入优化）
2. 创建 `diary_rag.py` 主程序
3. 实现 embedding 生成和存储
4. 实现混合检索逻辑
5. 实现 LLM 问答接口
6. （可选）实现标签预提取
7. 测试和优化

### 交互方式
```bash
python diary_rag.py
# 交互式问答
> 我去过几次日本？
根据日记记录，你去过日本共4次：
1. 2024年x月 - 东京（...）
2. 2025年3月 - 冲绳+福冈（...）
3. ...

> 我和猪头去过哪些好吃的餐厅？
...
```

---

## 注意事项
- ⚠️ 绝不删改日记源文件
- ⚠️ 不执行 git 操作
- 所有工具和数据库文件都在 `database_tools/` 目录下
- 纯本地运行

---

*创建时间: 2026-02-12*

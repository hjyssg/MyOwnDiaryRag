# æ—¥è®° RAG å›å¿†å·¥å…· â€” è¯¦ç»†è®¡åˆ’

## ç›®æ ‡

æ„å»ºä¸€ä¸ªçº¯æœ¬åœ°çš„æ—¥è®°å›å¿†ç³»ç»Ÿï¼Œç”¨æˆ·è¾“å…¥è‡ªç„¶è¯­è¨€é—®é¢˜ï¼Œç³»ç»Ÿä» 20 å¹´çš„æ—¥è®°ä¸­æ£€ç´¢ç›¸å…³å†…å®¹å¹¶ç”Ÿæˆå›ç­”ã€‚å…¨ç¨‹æ•°æ®ä¸å‡ºæœ¬æœºã€‚

## æ¶æ„

```
ç”¨æˆ·é—®é¢˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FTS5 æ£€ç´¢   â”‚ â† SQLite å…¨æ–‡æœç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
â”‚  æ‘˜è¦æ£€ç´¢     â”‚ â† æœç´¢å‹ç¼©æ‘˜è¦ï¼ˆè¯­ä¹‰æ›´é›†ä¸­ï¼‰
â”‚  æ—¥æœŸè¿‡æ»¤     â”‚ â† å¯é€‰çš„å¹´ä»½/æœˆä»½èŒƒå›´
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ Top-N ç»“æœ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Context ç»„è£… â”‚ â† æ‘˜è¦ç²—ç­› â†’ åŸæ–‡ç²¾é€‰ â†’ æ‹¼æ¥ prompt
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LM Studio   â”‚ â† Gemma (http://127.0.0.1:1234)
â”‚ æœ¬åœ°æ¨ç†     â”‚   OpenAI å…¼å®¹ API
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
   å›ç­”è¾“å‡º
```

## æŠ€æœ¯æ ˆ

| ç»„ä»¶ | é€‰æ‹© | è¯´æ˜ |
|------|------|------|
| æ•°æ®åº“ | SQLite + FTS5 | å·²æœ‰ï¼Œ4246 æ¡æ—¥è®° |
| å…¨æ–‡æœç´¢ | FTS5 | å·²å»ºå¥½ç´¢å¼• |
| æ‘˜è¦ç”Ÿæˆ | Gemma via LM Studio | æœ¬åœ° SLM é¢„å¤„ç† |
| é—®ç­”æ¨ç† | Gemma via LM Studio | OpenAI å…¼å®¹ API |
| è¯­è¨€ | Python | æ— é¢å¤–ä¾èµ– |

## æ•°æ®åº“æ‰©å±•

```sql
ALTER TABLE diary_entries ADD COLUMN summary TEXT;
```

åœ¨ `diary_fts` ä¸­ä¹ŸåŠ å…¥æ‘˜è¦ä»¥æ”¯æŒå…¨æ–‡æœç´¢ã€‚

## é˜¶æ®µä¸€ï¼šé¢„å¤„ç† â€” æ‘˜è¦ç”Ÿæˆ (`build_summaries.py`)

### æµç¨‹
1. ä»æ•°æ®åº“è¯»å–æ‰€æœ‰æ—¥è®°æ¡ç›®
2. è·³è¿‡å·²æœ‰æ‘˜è¦çš„æ¡ç›®ï¼ˆæ–­ç‚¹ç»­è·‘ï¼‰
3. å¯¹æ¯æ¡æ—¥è®°ï¼Œå‘é€ç»™ Gemma ç”Ÿæˆä¸€å¥è¯æ‘˜è¦ï¼ˆ~30-80å­—ï¼‰
4. å°†æ‘˜è¦å†™å›æ•°æ®åº“ `summary` åˆ—
5. åŒæ­¥æ›´æ–° FTS ç´¢å¼•

### Prompt è®¾è®¡
```
ä½ æ˜¯ä¸€ä¸ªæ—¥è®°æ‘˜è¦åŠ©æ‰‹ã€‚è¯·ç”¨ä¸€å¥è¯æ¦‚æ‹¬ä»¥ä¸‹æ—¥è®°çš„æ ¸å¿ƒå†…å®¹ï¼Œä¿ç•™å…³é”®äººç‰©ã€åœ°ç‚¹ã€äº‹ä»¶å’Œæƒ…ç»ªã€‚ä¸è¦æ·»åŠ ä»»ä½•è¯„è®ºã€‚

æ—¥æœŸï¼š{date}
æ—¥è®°å†…å®¹ï¼š
{content}

ä¸€å¥è¯æ‘˜è¦ï¼š
```

### æ€§èƒ½é¢„ä¼°
- 4246 æ¡æ—¥è®°
- Gemma æœ¬åœ°æ¨ç†çº¦ 1-3 ç§’/æ¡
- æ€»è®¡çº¦ 1-3 å°æ—¶
- æ”¯æŒ Ctrl+C ä¸­æ–­åç»­è·‘

### ç‰¹æ®Šå¤„ç†
- è¶…é•¿æ—¥è®°ï¼ˆ>2000å­—ï¼‰ï¼šæˆªå–å‰ 1500 å­— + å 500 å­—
- æçŸ­æ—¥è®°ï¼ˆ<20å­—ï¼‰ï¼šç›´æ¥ç”¨åŸæ–‡ä½œä¸ºæ‘˜è¦
- note ç±»å‹ï¼šå¯èƒ½åŒ…å«å¤šä¸ªä¸»é¢˜ï¼Œæ‘˜è¦å¯ä»¥ç¨é•¿ï¼ˆ2-3å¥ï¼‰

## é˜¶æ®µäºŒï¼šæ£€ç´¢ä¸é—®ç­” (`diary_rag.py`)

### æ£€ç´¢ç­–ç•¥ï¼ˆæ··åˆï¼‰

1. **FTS5 å…³é”®è¯æœç´¢**ï¼šä»åŸæ–‡å’Œæ‘˜è¦ä¸­æœç´¢
2. **æ—¥æœŸèŒƒå›´è¿‡æ»¤**ï¼šæ”¯æŒ "2023å¹´" "å»å¹´å¤å¤©" ç­‰æ—¶é—´è¡¨è¾¾
3. **ç±»å‹è¿‡æ»¤**ï¼šå¯æŒ‡å®šåªæœç”Ÿæ´»æ—¥è®°/è‚¡ç¥¨æ—¥è®°ç­‰

### æ£€ç´¢æµç¨‹
```
1. è§£æç”¨æˆ·é—®é¢˜ â†’ æå–å…³é”®è¯ + æ—¶é—´èŒƒå›´
2. FTS5 æœç´¢æ‘˜è¦ â†’ è¿”å› Top-30 å€™é€‰
3. FTS5 æœç´¢åŸæ–‡ â†’ è¿”å› Top-20 å€™é€‰
4. åˆå¹¶å»é‡ï¼ŒæŒ‰ç›¸å…³åº¦æ’åº
5. å– Top-10 çš„æ‘˜è¦ + Top-3 çš„åŸæ–‡
6. ç»„è£… context prompt
```

### Prompt è®¾è®¡ï¼ˆé—®ç­”ï¼‰
```
ä½ æ˜¯ä¸€ä¸ªç§äººæ—¥è®°åŠ©æ‰‹ã€‚æ ¹æ®ä»¥ä¸‹æ—¥è®°å†…å®¹å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚
åªåŸºäºæä¾›çš„æ—¥è®°å†…å®¹å›ç­”ï¼Œä¸è¦ç¼–é€ ä¿¡æ¯ã€‚å¦‚æœæ—¥è®°ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·å¦‚å®è¯´æ˜ã€‚

## ç›¸å…³æ—¥è®°æ‘˜è¦
{summaries}

## è¯¦ç»†æ—¥è®°å†…å®¹
{full_entries}

## ç”¨æˆ·é—®é¢˜
{question}

è¯·å›ç­”ï¼š
```

### äº¤äº’æ¨¡å¼
```
$ python diary_rag.py
ğŸ” æ—¥è®°å›å¿†åŠ©æ‰‹ (è¾“å…¥ quit é€€å‡º)

> æˆ‘ç¬¬ä¸€æ¬¡å»é©¬æ¥è¥¿äºšæ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ
[æ£€ç´¢ä¸­...] æ‰¾åˆ° 8 æ¡ç›¸å…³æ—¥è®°

ğŸ“… æ ¹æ®ä½ çš„æ—¥è®°ï¼Œä½ ç¬¬ä¸€æ¬¡å»é©¬æ¥è¥¿äºšæ˜¯ 2023å¹´8æœˆ30æ—¥...

> 2022å¹´å°åŸæœŸé—´æˆ‘åœ¨å¹²ä»€ä¹ˆï¼Ÿ
[æ£€ç´¢ä¸­...] æ‰¾åˆ° 15 æ¡ç›¸å…³æ—¥è®°

ğŸ“… 2022å¹´3æœˆåº•ä¸Šæµ·å¼€å§‹å°åŸ...
```

## æ–‡ä»¶ç»“æ„

```
database_tools/
â”œâ”€â”€ plan.md                  # æœ¬æ–‡ä»¶
â”œâ”€â”€ create_diary_db.sql      # æ•°æ®åº“ schema
â”œâ”€â”€ import_diary_to_db.py    # å¯¼å…¥è„šæœ¬
â”œâ”€â”€ build_summaries.py       # æ‘˜è¦ç”Ÿæˆï¼ˆé¢„å¤„ç†ï¼‰
â”œâ”€â”€ diary_rag.py             # RAG é—®ç­”å·¥å…·
â”œâ”€â”€ diary_database.db        # SQLite æ•°æ®åº“
â””â”€â”€ README.md
```

## å®æ–½æ­¥éª¤

1. âœ… æ•°æ®åº“å¯¼å…¥å®Œæˆï¼ˆ4246 æ¡ï¼Œ90.6ä¸‡å­—ï¼‰
2. æ‰©å±•æ•°æ®åº“ schemaï¼ˆæ·»åŠ  summary åˆ—ï¼‰
3. ç¼–å†™ `build_summaries.py`ï¼Œå…ˆæŠ½æ ·æµ‹è¯•å‡ æ¡
4. ç¡®è®¤æ‘˜è¦è´¨é‡åï¼Œå…¨é‡è·‘
5. ç¼–å†™ `diary_rag.py`
6. ç«¯åˆ°ç«¯æµ‹è¯•
